<script>
    // =================================================================
    // محرك الطباعة المركزي
    // =================================================================

    function printFormDirectly(formId, dataEncoded) {
        const printData = JSON.parse(decodeURIComponent(dataEncoded));
        
        // محاولة تعبئة المدير واللجنة إذا كانت ناقصة
        if (!printData.managerName && APP_DATA.settings) {
            printData.managerName = APP_DATA.settings.manager;
            printData.committeeMembers = APP_DATA.settings.committee;
        }

        showEnhancedToast('info', 'جاري تحضير النموذج...');

        google.script.run.withSuccessHandler(function(templateContent) {
            if (!templateContent || templateContent.length < 10) {
                showEnhancedToast('danger', 'خطأ: ملف القوالب (PrintTemplates) فارغ أو غير موجود!');
                return;
            }

            const printWindow = window.open('', '_blank');
            if (!printWindow) { 
                showEnhancedToast('danger', 'تم حظر النافذة! اسمح بالنوافذ المنبثقة (Pop-ups) لهذا الموقع.'); 
                return; 
            }

            printWindow.document.open();
            printWindow.document.write(templateContent);
            printWindow.document.close();

            setTimeout(function() {
                if (printWindow.fillForm) {
                    printWindow.fillForm(formId, printData);
                } else {
                    setTimeout(() => {
                        if (printWindow.fillForm) {
                            printWindow.fillForm(formId, printData);
                        } else {
                            console.error('Error: fillForm function not found.');
                            printWindow.alert('حدث خطأ في تحميل كود النموذج. يرجى المحاولة مرة أخرى.');
                        }
                    }, 500);
                }
            }, 300);

        }).getPrintTemplateContent();
    }
</script>