<script>
    // المتغيرات المحلية
    let selectedType = 'حضوري';
    // تعريف الألوان لكل قسم لتمييز الواجهة
    const THEMES = {
        'حضوري': { main: 'indigo', bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-200', ring: 'focus:ring-indigo-500' },
        'رقمي': { main: 'sky', bg: 'bg-sky-50', text: 'text-sky-600', border: 'border-sky-200', ring: 'focus:ring-sky-500' },
        'هيئة تعليمية': { main: 'rose', bg: 'bg-rose-50', text: 'text-rose-600', border: 'border-rose-200', ring: 'focus:ring-rose-500' }
    };

    // =================================================================
    // 1. رسم الصفحة (Rendering)
    // =================================================================
    function renderNewViolationPage() {
        const main = document.getElementById('main-content');
        main.innerHTML = `
            <div class="max-w-6xl mx-auto">
                <div class="bg-white rounded-t-2xl shadow-sm border-b border-gray-200 flex overflow-hidden">
                    <button onclick="setViolationType('حضوري')" id="tab-حضوري" class="tab-btn flex-1 py-5 text-sm font-bold transition-all border-b-4 border-indigo-600 bg-indigo-50 text-indigo-700 flex justify-center items-center gap-2">
                        <span class="material-symbols-outlined">school</span> مخالفات حضورية
                    </button>
                    <button onclick="setViolationType('رقمي')" id="tab-رقمي" class="tab-btn flex-1 py-5 text-sm font-medium text-gray-500 hover:bg-gray-50 transition-all border-b-4 border-transparent flex justify-center items-center gap-2">
                        <span class="material-symbols-outlined">devices</span> مخالفات رقمية
                    </button>
                    <button onclick="setViolationType('هيئة تعليمية')" id="tab-هيئة تعليمية" class="tab-btn flex-1 py-5 text-sm font-medium text-gray-500 hover:bg-gray-50 transition-all border-b-4 border-transparent flex justify-center items-center gap-2">
                        <span class="material-symbols-outlined">person_alert</span> تجاه الهيئة التعليمية
                    </button>
                </div>

                <div class="bg-white rounded-b-2xl shadow-lg border border-gray-100 p-8 space-y-8">
                    
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-end">
                        <div class="lg:col-span-3">
                            <label class="block text-xs font-bold text-gray-500 mb-2 mr-1">الصف الدراسي</label>
                            <div class="relative">
                                <select id="nv-grade" onchange="populateClasses()" class="w-full h-12 px-4 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white transition-all shadow-sm text-gray-700 font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none cursor-pointer">
                                    <option value="">اختر الصف</option>
                                </select>
                                <div class="absolute left-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400"><span class="material-symbols-outlined">expand_more</span></div>
                            </div>
                        </div>
                        <div class="lg:col-span-3">
                            <label class="block text-xs font-bold text-gray-500 mb-2 mr-1">الفصل</label>
                            <div class="relative">
                                <select id="nv-class" onchange="populateStudents()" disabled class="w-full h-12 px-4 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white transition-all shadow-sm text-gray-700 font-medium disabled:opacity-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none cursor-pointer">
                                    <option value="">اختر الفصل</option>
                                </select>
                                <div class="absolute left-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400"><span class="material-symbols-outlined">expand_more</span></div>
                            </div>
                        </div>
                        <div class="lg:col-span-6">
                            <label class="block text-xs font-bold text-gray-500 mb-2 mr-1">اسم الطالب</label>
                            <div class="relative">
                                <select id="nv-student" onchange="onStudentSelected()" disabled class="w-full h-12 px-4 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white transition-all shadow-sm text-gray-700 font-bold disabled:opacity-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none cursor-pointer">
                                    <option value="">اختر الطالب</option>
                                </select>
                                <div class="absolute left-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400"><span class="material-symbols-outlined">expand_more</span></div>
                            </div>
                        </div>
                    </div>

                    <div id="violation-section" class="hidden pt-6 border-t border-gray-100 animate-fade-in">
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            <div class="lg:col-span-4">
                                <label class="block text-xs font-bold text-gray-500 mb-2 mr-1">درجة المخالفة</label>
                                <div class="relative">
                                    <select id="nv-degree" onchange="populateViolationTexts()" class="w-full h-12 px-4 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white transition-all shadow-sm text-gray-700 font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none cursor-pointer">
                                        <option value="">اختر الدرجة</option>
                                    </select>
                                    <div class="absolute left-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400"><span class="material-symbols-outlined">expand_more</span></div>
                                </div>
                            </div>
                            <div class="lg:col-span-8">
                                <label class="block text-xs font-bold text-gray-500 mb-2 mr-1">نص المخالفة</label>
                                <div class="relative">
                                    <select id="nv-text" onchange="fetchProcedures()" disabled class="w-full h-12 px-4 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white transition-all shadow-sm text-gray-700 font-medium disabled:opacity-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none cursor-pointer">
                                        <option value="">اختر المخالفة</option>
                                    </select>
                                    <div class="absolute left-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400"><span class="material-symbols-outlined">expand_more</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="procedures-section" class="hidden pt-2 space-y-4">
                        <div id="repeat-alert-box"></div>

                        <h3 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                            <span class="material-symbols-outlined">format_list_bulleted</span> الإجراءات النظامية الواجبة:
                        </h3>
                        
                        <div id="procedures-list" class="grid grid-cols-1 gap-3 max-h-80 overflow-y-auto pr-1 custom-scrollbar"></div>
                        
                        <div class="flex justify-end items-center gap-3 pt-4 border-t border-gray-100 mt-4">
                            <div id="dynamic-print-buttons" class="flex gap-2"></div>
                            <button id="saveBtn" onclick="saveViolation()" disabled class="h-12 px-8 bg-indigo-600 text-white rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-xl disabled:opacity-50 disabled:shadow-none font-bold transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined">save</span> حفظ المخالفة
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        `;
        populateGrades();
        applyTheme('حضوري');
    }

    // =================================================================
    // 2. منطق التفاعل والثيمات
    // =================================================================
    
    function setViolationType(type) {
        selectedType = type;
        
        // 1. تحديث التبويبات
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.className = 'tab-btn flex-1 py-5 text-sm font-medium text-gray-500 hover:bg-gray-50 transition-all border-b-4 border-transparent flex justify-center items-center gap-2';
        });
        
        const activeBtn = document.getElementById(`tab-${type}`);
        const theme = THEMES[type];
        activeBtn.className = `tab-btn flex-1 py-5 text-sm font-bold transition-all border-b-4 border-${theme.main}-600 ${theme.bg} text-${theme.main}-700 flex justify-center items-center gap-2`;

        // 2. تنظيف حقول المخالفة
        const degreeSelect = document.getElementById('nv-degree');
        if(degreeSelect) { degreeSelect.innerHTML = '<option value="">اختر الدرجة</option>'; degreeSelect.value = ''; }
        
        const textSelect = document.getElementById('nv-text');
        if(textSelect) { textSelect.innerHTML = '<option value="">اختر المخالفة</option>'; textSelect.value = ''; textSelect.disabled = true; }
        
        document.getElementById('procedures-section').classList.add('hidden');
        document.getElementById('procedures-list').innerHTML = '';

        // 3. تطبيق الألوان
        applyTheme(type);

        // 4. إعادة تعبئة الدرجات
        if(document.getElementById('nv-student').value) {
            populateDegrees();
        }
    }

    function applyTheme(type) {
        const theme = THEMES[type];
        const inputs = document.querySelectorAll('select');
        inputs.forEach(input => {
            input.classList.remove('focus:ring-indigo-500', 'focus:ring-sky-500', 'focus:ring-rose-500');
            input.classList.add(theme.ring);
        });
        
        const saveBtn = document.getElementById('saveBtn');
        if(saveBtn) {
            saveBtn.className = `h-12 px-8 bg-${theme.main}-600 text-white rounded-xl shadow-lg shadow-${theme.main}-200 hover:bg-${theme.main}-700 hover:shadow-xl disabled:opacity-50 disabled:shadow-none font-bold transition-all flex items-center gap-2`;
        }
    }

    // =================================================================
    // 3. دوال تعبئة البيانات
    // =================================================================

    function populateGrades() {
        const select = document.getElementById('nv-grade');
        let grades = [...new Set(APP_DATA.students.filter(s => s['المرحلة'] === currentStage).map(s => s['الصف']))];
        const gradeOrder = ["أول", "ثاني", "ثالث", "رابع", "خامس", "سادس"];
        grades.sort((a, b) => {
            const indexA = gradeOrder.findIndex(key => a.includes(key));
            const indexB = gradeOrder.findIndex(key => b.includes(key));
            if (indexA !== -1 && indexB !== -1) return indexA - indexB;
            return a.localeCompare(b, 'ar');
        });
        select.innerHTML = '<option value="">اختر الصف</option>'; 
        grades.forEach(g => select.add(new Option(g, g)));
    }

    function populateClasses() {
        const grade = document.getElementById('nv-grade').value;
        const select = document.getElementById('nv-class');
        select.disabled = !grade;
        if(!grade) return;
        const classes = [...new Set(APP_DATA.students.filter(s => s['المرحلة'] === currentStage && s['الصف'] === grade).map(s => s['الفصل']))];
        classes.sort((a, b) => a.toString().localeCompare(b.toString(), 'ar', { numeric: true }));
        select.innerHTML = '<option value="">اختر الفصل</option>'; 
        classes.forEach(c => select.add(new Option(c, c)));
    }

    function populateStudents() {
        const grade = document.getElementById('nv-grade').value;
        const cls = document.getElementById('nv-class').value;
        const select = document.getElementById('nv-student');
        select.disabled = !cls;
        if(!cls) return;
        const students = APP_DATA.students.filter(s => s['المرحلة'] === currentStage && s['الصف'] === grade && s['الفصل'] == cls);
        students.sort((a, b) => a['اسم الطالب'].localeCompare(b['اسم الطالب'], 'ar'));
        select.innerHTML = '<option value="">اختر الطالب</option>'; 
        students.forEach(s => select.add(new Option(s['اسم الطالب'], s['رقم الطالب'])));
    }

    function onStudentSelected() { 
        document.getElementById('violation-section').classList.remove('hidden'); 
        populateDegrees(); 
    }

    function populateDegrees() {
        const select = document.getElementById('nv-degree');
        const violations = APP_DATA.violations.filter(v => v.type === selectedType);
        const degrees = [...new Set(violations.map(v => v.degree))].sort();
        select.innerHTML = '<option value="">اختر الدرجة</option>'; 
        degrees.forEach(d => select.add(new Option('الدرجة ' + d, d)));
    }

    function populateViolationTexts() {
        const degree = document.getElementById('nv-degree').value;
        const select = document.getElementById('nv-text');
        select.disabled = !degree;
        const violations = APP_DATA.violations.filter(v => v.type === selectedType && v.degree == degree);
        select.innerHTML = '<option value="">اختر المخالفة</option>'; 
        violations.forEach(v => select.add(new Option(v.text, v.id)));
    }

    // =================================================================
    // 4. منطق الإجراءات والحفظ
    // =================================================================

    function fetchProcedures() {
        const studentId = document.getElementById('nv-student').value;
        const violationId = document.getElementById('nv-text').value;
        document.getElementById('procedures-section').classList.remove('hidden');
        document.getElementById('procedures-list').innerHTML = `<div class="flex justify-center py-8"><div class="w-8 h-8 border-4 border-${THEMES[selectedType].main}-200 border-t-${THEMES[selectedType].main}-600 rounded-full animate-spin"></div></div>`;
        google.script.run.withSuccessHandler(showProcedures).calculateRepeatLevel(studentId, violationId);
    }

// =================================================================
    // 4. عرض الإجراءات (النسخة السليمة)
    // =================================================================
    function showProcedures(result) {
        const list = document.getElementById('procedures-list');
        const alertBox = document.getElementById('repeat-alert-box');
        const saveBtn = document.getElementById('saveBtn'); // تعريف زر الحفظ

        // 1. جلب الإجراءات من البيانات
        const violationId = document.getElementById('nv-text').value;
        const procedures = APP_DATA.procedures[violationId] ? (APP_DATA.procedures[violationId][result.repeatLevel] || []) : [];
        
        // 2. عرض تنبيه التكرار
        if (result.repeatLevel > 1) {
            alertBox.innerHTML = `
                <div class="flex items-center gap-4 p-4 mb-4 bg-orange-50 border-l-4 border-orange-500 rounded-r-xl shadow-sm animate-pulse">
                    <div class="p-2 bg-orange-100 rounded-full"><span class="material-symbols-outlined text-orange-600 text-2xl">warning</span></div>
                    <div>
                        <h4 class="font-bold text-orange-800">تنبيه تكرار المخالفة!</h4>
                        <p class="text-sm text-orange-700">هذه المخالفة تكررت للمرة <span class="font-bold text-lg">${result.repeatLevel}</span> لهذا الطالب.</p>
                    </div>
                </div>`;
        } else {
            alertBox.innerHTML = '';
        }
        
        // 3. بناء القائمة
        let html = '';
        if(procedures.length === 0) {
             html = '<div class="text-center py-4 text-gray-500">لا توجد إجراءات معرفة لهذا المستوى.</div>';
        } else {
            const theme = THEMES[selectedType];
            procedures.forEach(p => {
                // تحديد هوية النموذج (تصحيح هام جداً)
                let fId = p.formId || '';
                // إذا لم يأتِ ID من السيرفر، نخمنه بناءً على الاسم لضمان العمل
                if (!fId && p.formName) {
                    if (p.formName.includes('فرص تعويض')) fId = 'tawid_darajat';
                    else if (p.formName.includes('إحالة')) fId = 'ehalat_talib';
                    else if (p.formName.includes('ولي الأمر')) fId = 'ishar_wali_amr';
                    else if (p.formName.includes('تعهد')) fId = 'tahood_slooki';
                }

                html += `
                    <label class="group flex items-start gap-4 p-4 bg-white border border-gray-200 rounded-xl cursor-pointer hover:border-${theme.main}-300 hover:bg-${theme.main}-50 hover:shadow-md transition-all duration-200 select-none">
                        <div class="flex items-center h-6">
                            <input type="checkbox" 
                                   value="${p.text}" 
                                   data-form-name="${p.formName || ''}" 
                                   data-form-id="${fId}"
                                   onchange="updatePrintButtons()" 
                                   class="w-5 h-5 text-${theme.main}-600 border-gray-300 rounded focus:ring-${theme.main}-500 cursor-pointer">
                        </div>
                        <div class="flex-1 procedure-text-container">
                            <span class="text-gray-700 font-medium group-hover:text-${theme.main}-800 transition-colors leading-relaxed">${p.text}</span>
                        </div>
                    </label>
                `;
            });
        }
        
        // 4. وضع المحتوى (هنا تختفي الدائرة)
        list.innerHTML = html;
        
        // 5. تفعيل زر الحفظ (هام جداً)
        if(saveBtn) saveBtn.disabled = false;

        // 6. تحديث الأزرار (إذا كانت هناك خيارات محددة مسبقاً)
        updatePrintButtons();
    }

    // =================================================================
    // 5. تحديث أزرار الطباعة (تم حذف الكود المسبب للمشكلة)
    // =================================================================
    function updatePrintButtons() {
        // حذف الأزرار القديمة
        document.querySelectorAll('.print-btn-inline').forEach(btn => btn.remove());

        const container = document.getElementById('procedures-list');
        if(!container) return;

        const selectedCheckboxes = container.querySelectorAll('input[type="checkbox"]:checked');
        
        selectedCheckboxes.forEach(cb => {
            // قراءة البيانات من الـ Checkbox نفسه (بدلاً من المتغير المفقود)
            const actionLabel = cb.value; 
            const formName = cb.dataset.formName;
            const formId = cb.dataset.formId;
            
            // رسم الزر إذا وُجد نموذج
            if (formName && formName !== 'undefined' && formName !== '') {
                const btn = document.createElement('button');
                // تنسيق الزر
                btn.className = 'print-btn-inline btn btn-sm bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100 ms-3 inline-flex items-center gap-1 px-2 py-0.5 rounded-lg text-xs font-bold transition-all mt-2';
                btn.innerHTML = `<span class="material-symbols-outlined text-[14px]">print</span> ${formName}`;
                
                // أمر الطباعة
                btn.onclick = (e) => {
                    e.preventDefault(); 
                    e.stopPropagation();
                    printCurrentContext(formId, actionLabel);
                };
                
                // إضافة الزر بجانب النص
                const textContainer = cb.closest('label').querySelector('.procedure-text-container');
                if (textContainer) {
                    textContainer.appendChild(btn);
                }
            }
        });
    }

  // =================================================================
// 3. دالة الطباعة (النسخة الشاملة والنهائية)
// =================================================================
function printCurrentContext(formId, actionText = '') {
    // 1. التحقق من اختيار الطالب
    const studentSelect = document.getElementById('nv-student');
    if (!studentSelect || !studentSelect.value) {
        showEnhancedToast('danger', 'يرجى اختيار الطالب أولاً');
        return;
    }
    
    // 2. جلب بيانات الطالب
    const studentName = studentSelect.options[studentSelect.selectedIndex].text;
    const grade = document.getElementById('nv-grade').value;
    const cls = document.getElementById('nv-class').value;

    // 3. جلب بيانات المخالفة
    const vSelect = document.getElementById('nv-text');
    const vName = vSelect.options[vSelect.selectedIndex].text;
    
    const vDegreeSelect = document.getElementById('nv-degree');
    let vDegree = vDegreeSelect.value;
    if (vDegree.includes(' ')) vDegree = vDegree.split(' ')[1];

    // 4. التاريخ واليوم
    const today = new Date();
    const vDate = today.toLocaleDateString('ar-SA-u-ca-islamic');
    const vDay = today.toLocaleDateString('ar-SA', { weekday: 'long' });

    // 5. جمع الإجراءات المختارة
    const procedures = [];
    document.querySelectorAll('#procedures-list input:checked').forEach(cb => {
        procedures.push(cb.value);
    });

    // 6. حساب الدرجات المحسومة (للنموذج tawid_darajat)
    let foundPoints = '0';
    if (formId === 'tawid_darajat') {
        let allCheckedTexts = procedures.join(' ') + ' ' + actionText;
        
        const numberMatch = allCheckedTexts.match(/(\d+)/);
        if (numberMatch) {
            foundPoints = numberMatch[0];
        } else if (allCheckedTexts.includes('درجة واحدة') || allCheckedTexts.includes('درجة من')) {
            foundPoints = '1';
        } else if (allCheckedTexts.includes('درجتين') || allCheckedTexts.includes('درجتان')) {
            foundPoints = '2';
        } else if (allCheckedTexts.includes('ثلاث درجات')) {
            foundPoints = '3';
        } else if (allCheckedTexts.includes('كامل الدرجة')) {
            foundPoints = 'كامل الدرجة';
        }
    }

    // 7. تجهيز حزمة البيانات الشاملة
    let printData = {
        // بيانات الطالب
        studentName: studentName,
        grade: grade,
        class: cls,
        
        // بيانات المخالفة
        violationDate: vDate,
        violationDay: vDay,
        violationDegree: vDegree,
        violationText: vName,
        
        // الإجراءات
        procedures: procedures,
        
        // بيانات المخالفة للنموذج الجديد (فرص التعويض)
        violationInfo: {
            name: vName,
            degree: vDegree,
            date: vDate,
            points: foundPoints
        }
    };

    // 8. إضافة بيانات الإعدادات (المدير، اللجنة، الوكيل)
    if (APP_DATA.settings) {
        // اسم المدير
        if (APP_DATA.settings.manager) {
            printData.managerName = APP_DATA.settings.manager;
        }
        
        // أعضاء اللجنة
        if (APP_DATA.settings.committee) {
            printData.committeeMembers = APP_DATA.settings.committee;
        }
        
        // اسم الوكيل
        if (APP_DATA.settings.deputies && APP_DATA.settings.deputies.length > 0) {
            printData.deputyName = APP_DATA.settings.deputies[0].name;
        }
    }

    // 9. تنفيذ الطباعة
    printFormDirectly(formId, encodeURIComponent(JSON.stringify(printData)));
}
    
    function saveViolation() {
        const studentId = document.getElementById('nv-student').value;
        const violationId = document.getElementById('nv-text').value;
        const procedures = []; 
        const forms = [];
        document.querySelectorAll('#procedures-list input:checked').forEach(cb => { 
            procedures.push(cb.value); 
            if(cb.dataset.form) forms.push(cb.dataset.form); 
        });
        const btn = document.getElementById('saveBtn'); 
        btn.disabled = true; 
        btn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> جاري الحفظ...';
        google.script.run.withSuccessHandler((response) => {
            if(response.success) {
                showEnhancedToast('success', 'تم حفظ المخالفة بنجاح');
                document.getElementById('nv-student').value = '';
                document.getElementById('violation-section').classList.add('hidden');
                document.getElementById('procedures-section').classList.add('hidden');
            } else {
                showEnhancedToast('danger', 'حدث خطأ: ' + response.error);
            }
            btn.innerHTML = '<span class="material-symbols-outlined">save</span> حفظ المخالفة'; 
            btn.disabled = false;
        }).saveViolation({ studentId, violationId, procedures, forms });
    }
</script>